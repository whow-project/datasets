@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix fnml: <http://semweb.mmlab.be/ns/fnml#> .
@prefix grel: <http://users.ugent.be/~bjdmeest/function/grel.ttl#> .
@prefix fno: <https://w3id.org/function/ontology#> .
@prefix idlab-fn: <http://example.com/idlab/function/> .
@prefix sd: <http://www.w3.org/ns/sparql-service-description#> .
@prefix ispra-mf: <https://dati.isprambiente.it/ontology/ispra-mf/>.
@prefix places: <https://w3id.org/stlab/places/> .
@prefix top: <https://dati.isprambiente.it/ontology/top/> .
@prefix crml: <http://w3id.org/stlab/crml#> .
@prefix hydro: <https://w3id.org/whow/onto/hydrography/>.
@prefix w-mon: <https://w3id.org/whow/onto/water-monitoring/>.
@base <https://w3id.org/whow/data/water-monitoring/> .


#java -jar .\rmlmapper-4.15.0-r361-all.jar -m ostreopsis-ovata.ttl -o ostreopsis-ovata-output.ttl -s turtle


# #LogicalSourceOstreopsis
<#LogicalSourceOstreopsis> a rml:BaseSource ;
    rml:source [
      a csvw:Table;
      csvw:url "Ostreopsis_Ovata_AllRegions_withISTATcode.csv";

      csvw:dialect [
        a csvw:Dialect;
        csvw:delimiter ";"
      ]
    ];
    rml:referenceFormulation ql:CSV .


    ###########################################################
    ##                  MAPPING RULES
    ##########################################################

    <#WaterObservationMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;

    rr:subjectMap [
    fnml:functionValue [
     rr:predicateObjectMap [
     rr:predicate fno:executes ;
     rr:objectMap [ rr:constant grel:array_join ]
   ] ;
   rr:predicateObjectMap [
     rr:predicate grel:p_array_a ;
     rr:objectMap  [ rr:constant "http://w3id.org/whow/data/water-observation"]
   ];

   rr:predicateObjectMap [
     rr:predicate grel:p_array_a ;
     rr:objectMap  <#MD5Execution>
   ];
   rr:predicateObjectMap [
     rr:predicate grel:p_string_sep ;
     rr:objectMap [ rr:constant "/" ]
   ];
  ];
  rr:class w-mon:SurfaceOrGroundWaterObservation, w-mon:WaterBiologicalQualityParameterObservation, w-mon:WaterObservation;
  #rr:termType rr:IRI;
  ];
  rr:predicateObjectMap [
   rr:predicate rdfs:label ;
   rr:objectMap [
       rr:template "Observation for the water feature {Codice Sito} for the date {Data}." ; rr:language "en" ]
       ];
       rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [
            rr:template "Osservazione per la water feature {Codice Sito} in data {Data}." ; rr:language "it" ]
            ];
  rr:predicateObjectMap [
    rr:predicate w-mon:hasResult ;
    rr:objectMap <#ResultsCleaningMapping>;
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasMunicipality ;
    rr:objectMap  <#MunicipalityFunction>
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasRegion ;
    rr:objectMap [ rr:template "https://w3id.org/whow/data/region/{Regione}"; #funzione specifica
    rr:termType rr:IRI
    ]
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasProvince ;
    rr:objectMap <#ProvincesCleanURIMapping>;
  ];
  rr:predicateObjectMap [
    rr:predicate w-mon:hasResult ;
    rr:objectMap <#ResultsCleaningMapping2>;
  ];

  rr:predicateObjectMap [
     rr:predicate w-mon:hasWaterObservableProperty ;
     rr:objectMap [
        rr:template "http://w3id.org/whow/data/observable-property/concentrazione-di-ostreopsis-ovata"; #voc contr
        rr:termType rr:IRI;]
   ];
   rr:predicateObjectMap [
      rr:predicate w-mon:hasObservationSample ;
      rr:objectMap [
         rr:template "http://w3id.org/whow/data/water-sample/{Ostreopsis cf. ovata (cell/l)}-cell-l-{LAT}-{LONG}"; #voc contr
         rr:termType rr:IRI;]
    ];
    rr:predicateObjectMap [
       rr:predicate w-mon:hasObservationSample ;
       rr:objectMap [
          rr:template "http://w3id.org/whow/data/water-sample/{Ostreopsis cf. ovata (cell/ g fw)}-cell-g-fw-{LAT}-{LONG}"; #voc contr
          rr:termType rr:IRI;]
     ];
   rr:predicateObjectMap [
      rr:predicate ispra-mf:generationTime ;
      rr:objectMap [
         rr:template "http://w3id.org/whow/data/time/{Data}"; #normalizzare data
         rr:termType rr:IRI;]
    ].

## water sample mapping
<#WaterSampleMapping> a rr:TriplesMap;
rml:logicalSource <#LogicalSourceOstreopsis>;
rr:subjectMap [
        rr:template "http://w3id.org/whow/data/water-sample/{Ostreopsis cf. ovata (cell/l)}-cell-l-{LAT}-{LONG}";
        rr:class w-mon:WaterSample
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
   rr:constant "Water sample for {Ostreopsis cf. ovata (cell/l)} cell/l." ; rr:language "en"]
          ].

<#WaterSampleMapping2> a rr:TriplesMap;
rml:logicalSource <#LogicalSourceOstreopsis>;
rr:subjectMap [
        rr:template "http://w3id.org/whow/data/water-sample/{Ostreopsis cf. ovata (cell/ g fw)}-cell-g-fw-{LAT}-{LONG}";
        rr:class w-mon:WaterSample
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
   rr:constant "Water sample for {Ostreopsis cf. ovata (cell/ g fw)} cell/g fw." ; rr:language "en"]
          ].




## result mapping

    <#ResultMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;
    rr:subjectMap [
    fnml:functionValue [
     rr:predicateObjectMap [
       rr:predicate fno:executes ;
       rr:objectMap [ rr:constant grel:array_join ]
     ];

      rr:predicateObjectMap [
        rr:predicate grel:p_array_a ;
        rr:objectMap [ rr:constant "https://w3id.org/whow/data/observation-result/"]
      ] ;
      rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
           rr:objectMap
                   [rml:reference "Ostreopsis cf. ovata (cell/l)"]

      ];
      rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
           rr:objectMap
                   [rr:constant "cell-l"]

      ];
      rr:predicateObjectMap [
        rr:predicate grel:p_string_sep ;
        rr:objectMap [ rr:constant "-" ]
      ]
    ];
          rr:class w-mon:ObservationValue
                ];
     rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [
           rr:template "Observation value {Ostreopsis cf. ovata (cell/l)}" ; rr:language "en" ] #agg datatype property
      ];

      rr:predicateObjectMap [
        rr:predicate top:hasUnitOfMeasure;
        rr:objectMap [rr:template "http://w3id.org/whow/data/um/cell-l";
        rr:termType rr:IRI;]

        ].


        <#ResultMapping2> a rr:TriplesMap;
        rml:logicalSource <#LogicalSourceOstreopsis>;
        rr:subjectMap [
        fnml:functionValue [
         rr:predicateObjectMap [
           rr:predicate fno:executes ;
           rr:objectMap [ rr:constant grel:array_join ]
         ];

          rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
            rr:objectMap [ rr:constant "https://w3id.org/whow/data/observation-result/"]
          ] ;
          rr:predicateObjectMap [
                rr:predicate grel:p_array_a ;
                rr:objectMap
                        [rml:reference "Ostreopsis cf. ovata (cell/ g fw)"]

          ];
          rr:predicateObjectMap [
                rr:predicate grel:p_array_a ;
                rr:objectMap
                        [rr:constant "cell-g-fw"]

          ];
          rr:predicateObjectMap [
            rr:predicate grel:p_string_sep ;
            rr:objectMap [ rr:constant "-" ]
          ]
        ];
              rr:class w-mon:ObservationValue
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
               rr:template "Observation value {Ostreopsis cf. ovata (cell/ g fw)}" ; rr:language "en" ] #agg datatype property
          ];

          rr:predicateObjectMap [
            rr:predicate top:hasUnitOfMeasure;
            rr:objectMap [rr:template "http://w3id.org/whow/data/um/cell-g-fw";
            rr:termType rr:IRI;]

            ].


        ### observable property Mapping
        <#ObservablePropertyMapping> a rr:TriplesMap;
        rml:logicalSource <#LogicalSourceOstreopsis>;
        rr:subjectMap [
        rr:template "http://w3id.org/whow/data/observable-property/concentrazione-di-ostreopsis-ovata";
        rr:class w-mon:WaterObservableProperty
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
               rr:constant "Concentrazione di ostreopsis ovata. Codice AlgaeBase: 52502; Codice Worms: 110068." ; rr:language "it"]
          ];
          rr:predicateObjectMap [
             rr:predicate skos:prefLabel ;
             rr:objectMap [
                rr:constant "Concentrazione di ostreopsis ovata." ; rr:language "it"]
           ];
          rr:predicateObjectMap [
         rr:predicate skos:notation ;
         rr:objectMap [
            rr:constant "AlgaeBase:52502"; rr:datatype xsd:string]
       ];
       rr:predicateObjectMap [
      rr:predicate skos:notation ;
      rr:objectMap [
         rr:constant "Worms:110068"; rr:datatype xsd:string]
    ];
    rr:predicateObjectMap [
   rr:predicate top:hasUniqueIdentifier ;
   rr:objectMap [
      rr:template "https://w3id.org/whow/data/identifier/52502"; rr:termType rr:IRI]
 ];
 rr:predicateObjectMap [
rr:predicate top:hasUniqueIdentifier ;
rr:objectMap [
   rr:template "https://w3id.org/whow/data/identifier/110068"; rr:termType rr:IRI]
];
         rr:predicateObjectMap [
            rr:predicate w-mon:hasBiologicalAgent ;
            rr:objectMap [rr:template "http://w3id.org/whow/data/biological-agents/biological-agent/ostreopsis-ovata"; rr:termType rr:IRI]
            ];
            rr:predicateObjectMap [
               rr:predicate owl:sameAs ;
               rr:objectMap [rr:template "http://www.wikidata.org/entity/Q1462884"; rr:termType rr:IRI]
               ].
#water feature (sea) mapping
            <#WaterFeatureBasinMapping> a rr:TriplesMap;
            rml:logicalSource <#LogicalSourceOstreopsis>;
            rr:subjectMap [
            rr:template "http://w3id.org/whow/data/water-feature/{Codice Sito}";
            rr:class hydro:MarineWaterBody
                        ];
             rr:predicateObjectMap [
                rr:predicate rdfs:label ;
                rr:objectMap [
                   rr:template "Marine water feature {Codice Sito}, {Nome Sito}." ; rr:language "en"]
              ];
              rr:predicateObjectMap [
                 rr:predicate top:hasUniqueIdentifier ;
                 rr:objectMap [rr:template "http://w3id.org/whow/data/identifier/{Codice Sito}"; rr:termType rr:IRI]
               ].

              <#UnitOfMeasureMapping> a rr:TriplesMap;
              rml:logicalSource <#LogicalSourceOstreopsis>;
              rr:subjectMap [
              rr:template "http://w3id.org/whow/data/um/cell-l";
              rr:class top:UnitOfMeasure
                          ];
               rr:predicateObjectMap [
                  rr:predicate rdfs:label ;
                  rr:objectMap [
                     rr:template "Unit of measure cell/l." ; rr:language "en"]
                ].

#biological agents mappingoutput
<#BiologicalAgentMapping> a rr:TriplesMap;
rml:logicalSource <#LogicalSourceOstreopsis>;
rr:subjectMap [
rr:template "http://w3id.org/whow/data/biological-agents/biological-agent/ostreopsis-ovata";
rr:class w-mon:BiologicalAgent
          ];
rr:predicateObjectMap [
  rr:predicate rdfs:label ;
  rr:objectMap [
     rr:template "Ostreopsis ovata." ; rr:language "it"] #controllare voc contr
];
rr:predicateObjectMap [
   rr:predicate skos:altLabel ;
   rr:objectMap [
      rr:template "Ostreopsis ovata."; rr:language "it"]
 ].


##Municipality MAPPING

<#MunicipalityMapping> a rr:TriplesMap;
rml:logicalSource <#LogicalSourceOstreopsis>;
rr:subjectMap [
rr:template "http://w3id.org/whow/data/municipality/{PRO_COM_T}";
rr:class places:Province
];
rr:predicateObjectMap [
   rr:predicate rdfs:label ;
   rr:objectMap [
      rr:template "Municipality of {Comune}" ; rr:language "en"]
 ].


 #ProvincesMapping
 <#ProvincesMapping> a rr:TriplesMap;
 rml:logicalSource <#LogicalSourceOstreopsis>;
 rr:subjectMap <#ProvincesCleanURIMapping>;
  rr:predicateObjectMap [
     rr:predicate rdfs:label ;
     rr:objectMap [
        rr:template "Province of {Provincia}" ; rr:language "en"] #controllare voc contr
   ];
   rr:predicateObjectMap [
      rr:predicate rdfs:label ;
      rr:objectMap [
         rr:template "Provincia di {Provincia}" ; rr:language "it"] #controllare voc contr
    ];
   .


    #Regionmapping
    <#RegionMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;
    rr:subjectMap [
    rr:template "https://w3id.org/whow/data/region/{Regione}";
    rr:termType rr:IRI
    ];
    rr:predicateObjectMap [
       rr:predicate rdfs:label ;
       rr:objectMap [
          rr:template "Region {Regione}" ; rr:language "en"]
     ].

     #Regionmapping
     <#ProvinceMapping> a rr:TriplesMap;
     rml:logicalSource <#LogicalSourceOstreopsis>;
     rr:subjectMap [
     rr:template "https://w3id.org/whow/data/province/{Provincia}";
     rr:termType rr:IRI
     ];
     rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [
           rr:template "Province {Provincia}" ; rr:language "en"]
      ].

#MD5Execution
<#MD5Execution>
fnml:functionValue [
    rml:logicalSource <#LogicalSourceOstreopsis> ;
rr:predicateObjectMap [
       rr:predicate fno:executes ;
       rr:objectMap [ rr:constant grel:string_md5 ]
     ];
     rr:predicateObjectMap [
     rr:predicate grel:valueParameter ;
     rr:objectMap <#ArrayJoinInteraRiga>
       ];
    ].


### Array join intera riga

<#ArrayJoinInteraRiga>
fnml:functionValue [
    rml:logicalSource <#LogicalSourceOstreopsis> ;
rr:predicateObjectMap [
  rr:predicate fno:executes ;
  rr:objectMap [ rr:constant grel:array_join ]
] ;
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Regione}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Provincia}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Comune}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Codice Sito}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Nome Sito}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{LONG}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{LAT}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Data}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Ostreopsis cf. ovata (cell/l)}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_string_sep ;
  rr:objectMap [ rr:constant "-" ]
];
].

<#MunicipalityFunction>
fnml:functionValue [
 rr:predicateObjectMap [
 rr:predicate fno:executes ;
 rr:objectMap [ rr:constant grel:array_join ]
] ;
rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
 rr:objectMap  [ rr:constant "http://w3id.org/whow/data/municipality"]
];

rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
 rr:objectMap  [rr:template "{PRO_COM_T}"]
];
rr:predicateObjectMap [
 rr:predicate grel:p_string_sep ;
 rr:objectMap [ rr:constant "/" ]
];
rr:termtype rr:IRI
].

<#ResultsCleaningMapping>
#se c'è lo slash come risultato, esplicito che il monitoraggio non è stato effettuato
rr:termType rr:IRI ;
fnml:functionValue [
rml:logicalSource <#LogicalSourceOstreopsis>;
 rr:predicateObjectMap [
   rr:predicate fno:executes ;
   rr:objectMap [ rr:constant idlab-fn:trueCondition ]
 ];

  rr:predicateObjectMap [
    rr:predicate idlab-fn:strBoolean ;
    rr:objectMap <#isSlash>
  ] ;

  rr:predicateObjectMap [
    rr:predicate idlab-fn:str ;
    rr:objectMap <#ResultURI>
  ]
].

<#isSlash>
fnml:functionValue [
rml:logicalSource <#LogicalSourceOstreopsis>;
   rr:predicateObjectMap [
  rr:predicate fno:executes ;
   rr:objectMap [ rr:constant grel:string_contains ]
   ];

   rr:predicateObjectMap [
   rr:predicate grel:valueParameter ;
     rr:objectMap [ rml:reference "Ostreopsis cf. ovata (cell/l)" ]
   ] ;
rr:predicateObjectMap [
rr:predicate grel:string_sub ;
rr:objectMap [ rr:constant "/" ]
     ];
   ].

 <#ResultURI>
 rr:termType rr:IRI ;
fnml:functionValue [
rml:logicalSource <#LogicalSourceOstreopsis>;
 rr:predicateObjectMap [
   rr:predicate fno:executes ;
rr:objectMap [ rr:constant grel:array_join ]
     ] ;
   rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
   rr:objectMap  [ rr:constant "https://w3id.org/whow/data/observation-result"]
                     ];
 rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
 rr:objectMap [rr:constant "monitoring-not-made"]
 ];
 rr:predicateObjectMap [
rr:predicate grel:p_string_sep ;
 rr:objectMap [ rr:constant "/" ]
 ];
 ].


 <#ResultsCleaningMapping2>
 #se c'è lo slash come risultato, esplicito che il monitoraggio non è stato effettuato
 rr:termType rr:IRI ;
 fnml:functionValue [
 rml:logicalSource <#LogicalSourceOstreopsis>;
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant idlab-fn:trueCondition ]
  ];

   rr:predicateObjectMap [
     rr:predicate idlab-fn:strBoolean ;
     rr:objectMap <#isSlash2>
   ] ;

   rr:predicateObjectMap [
     rr:predicate idlab-fn:str ;
     rr:objectMap <#ResultURI>
   ]
 ].

 <#isSlash2>
 fnml:functionValue [
 rml:logicalSource <#LogicalSourceOstreopsis>;
    rr:predicateObjectMap [
   rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:string_contains ]
    ];

    rr:predicateObjectMap [
    rr:predicate grel:valueParameter ;
      rr:objectMap [ rml:reference "Ostreopsis cf. ovata (cell/ g fw)" ]
    ] ;
 rr:predicateObjectMap [
 rr:predicate grel:string_sub ;
 rr:objectMap [ rr:constant "/" ]
      ];
    ].

#provinces clean URI
<#ProvincesCleanURIMapping>
fnml:functionValue [
  rml:logicalSource <#LogicalSourceOstreopsis>;
 rr:predicateObjectMap [
   rr:predicate fno:executes ;
   rr:objectMap [ rr:constant grel:array_join ]
 ];
 rr:predicateObjectMap [
     rr:predicate grel:valueParameter ;
     rr:objectMap [ rml:reference "Provincia"]
     ];
  rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap [ rr:constant "https://w3id.org/whow/data/province/"]
  ] ;
  rr:predicateObjectMap [
        rr:predicate grel:p_array_a ;
        rr:objectMap
                <#ReplaceWhitespacesWithDashProvince>

  ];
];
rr:class places:Province;
rr:termType rr:IRI .

    <#ReplaceWhitespacesWithDashProvince>
    fnml:functionValue [
      rml:logicalSource <#LogicalSourceOstreopsis>;
      rr:predicateObjectMap [
        rr:predicate fno:executes ;
        rr:objectMap [ rr:constant grel:string_replaceChars ]
     ];
      rr:predicateObjectMap [
        rr:predicate grel:p_string_find ;
        rr:objectMap [ rr:constant " " ]
      ];
      rr:predicateObjectMap [
        rr:predicate grel:p_string_replace ;
        rr:objectMap [ rr:constant "-" ]
];
     ].
