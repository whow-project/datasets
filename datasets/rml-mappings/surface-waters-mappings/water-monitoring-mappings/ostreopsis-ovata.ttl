@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix fnml: <http://semweb.mmlab.be/ns/fnml#> .
@prefix grel: <http://users.ugent.be/~bjdmeest/function/grel.ttl#> .
@prefix fno: <https://w3id.org/function/ontology#> .
@prefix idlab-fn: <http://example.com/idlab/function/> .
@prefix sd: <http://www.w3.org/ns/sparql-service-description#> .
@prefix inspire-mf: <https://dati.isprambiente.it/ontology/inspire-mf/>.
@prefix places: <https://w3id.org/stlab/places/> .
@prefix core: <https://dati.isprambiente.it/ontology/core/> .
@prefix crml: <http://w3id.org/stlab/crml#> .
@prefix hydro: <https://w3id.org/whow/onto/hydrography/>.
@prefix w-mon: <https://w3id.org/whow/onto/water-monitoring/>.
@base <https://w3id.org/whow/data/water-monitoring/> .


#java -jar .\rmlmapper-4.15.0-r361-all.jar -m ostreopsis-ovata-rinominati.ttl -o ostreopsis-ovata-output.ttl -s turtle


# #LogicalSourceOstreopsis
<#LogicalSourceOstreopsis> a rml:BaseSource ;
    rml:source [
      a csvw:Table;
      csvw:url "ostreopsis-ovata-tutte-le-regioni.csv";

      csvw:dialect [
        a csvw:Dialect;
        csvw:delimiter ","
      ]
    ];
    rml:referenceFormulation ql:CSV .


    ###########################################################
    ##                  MAPPING RULES
    ##########################################################

    <#WaterObservationMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;

    rr:subjectMap [
    fnml:functionValue [
     rr:predicateObjectMap [
     rr:predicate fno:executes ;
     rr:objectMap [ rr:constant grel:array_join ]
   ] ;
   rr:predicateObjectMap [
     rr:predicate grel:p_array_a ;
     rr:objectMap  [ rr:constant "http://w3id.org/whow/data/water-observation"]
   ];

   rr:predicateObjectMap [
     rr:predicate grel:p_array_a ;
     rr:objectMap  <#MD5Execution>
   ];
   rr:predicateObjectMap [
     rr:predicate grel:p_string_sep ;
     rr:objectMap [ rr:constant "/" ]
   ];
  ];
  rr:class w-mon:MarineWaterObservation;
  #rr:termType rr:IRI;
  ];
  rr:predicateObjectMap [
   rr:predicate rdfs:label ;
   rr:objectMap [
       rr:template "Observation for the water feature {Codice Sito} for the date {Data}." ; rr:language "en" ]
       ];

  rr:predicateObjectMap [
    rr:predicate w-mon:hasResult ;
    rr:objectMap [rr:template "https://w3id.org/whow/data/observation-result/{Ostreopsisovatacelll}-cell-l";
    rr:termType rr:IRI;]
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasMunicipality ;
    rr:objectMap  <#MunicipalityFunction>
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasRegion ;
    rr:objectMap [ rr:template "https://w3id.org/whow/data/municipality/{Regione}";
    rr:termType rr:IRI
    ]
  ];
  rr:predicateObjectMap [
    rr:predicate places:hasProvince ;
    rr:objectMap [ rr:template "https://w3id.org/whow/data/municipality/{Provincia}";
    rr:termType rr:IRI
    ]
  ];
  rr:predicateObjectMap [
    rr:predicate w-mon:hasResult ;
    rr:objectMap [rr:template "https://w3id.org/whow/data/observation-result/{Ostreopsisovatacellgfw}cell-g-fw";
    rr:termType rr:IRI;]
  ];

  rr:predicateObjectMap [
     rr:predicate w-mon:hasWaterObservableProperty ;
     rr:objectMap [
        rr:template "http://w3id.org/whow/data/observable-property/concentrazione-di-ostreopsis-ovata";
        rr:termType rr:IRI;]
   ];

   rr:predicateObjectMap [
      rr:predicate inspire-mf:generationTime ;
      rr:objectMap [
         rr:template "http://w3id.org/whow/data/time/{Data}";
         rr:termType rr:IRI;]
    ].

## result mapping

    <#ResultMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;
    rr:subjectMap [
    fnml:functionValue [
     rr:predicateObjectMap [
       rr:predicate fno:executes ;
       rr:objectMap [ rr:constant grel:array_join ]
     ];

      rr:predicateObjectMap [
        rr:predicate grel:p_array_a ;
        rr:objectMap [ rr:constant "https://w3id.org/whow/data/observation-result/"]
      ] ;
      rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
           rr:objectMap
                   [rml:reference "Ostreopsisovatacelll"]

      ];
      rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
           rr:objectMap
                   [rr:constant "cell-l"]

      ];
      rr:predicateObjectMap [
        rr:predicate grel:p_string_sep ;
        rr:objectMap [ rr:constant "-" ]
      ]
    ];
          rr:class w-mon:ObservationValue
                ];
     rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [
           rr:template "Observation value {Ostreopsisovatacelll}" ; rr:language "en" ] #agg datatype property
      ];

      rr:predicateObjectMap [
        rr:predicate core:hasUnitOfMeasure;
        rr:objectMap [rr:template "http://w3id.org/whow/data/um/cell-l";
        rr:termType rr:IRI;]

        ].


        <#ResultMapping2> a rr:TriplesMap;
        rml:logicalSource <#LogicalSourceOstreopsis>;
        rr:subjectMap [
        fnml:functionValue [
         rr:predicateObjectMap [
           rr:predicate fno:executes ;
           rr:objectMap [ rr:constant grel:array_join ]
         ];

          rr:predicateObjectMap [
            rr:predicate grel:p_array_a ;
            rr:objectMap [ rr:constant "https://w3id.org/whow/data/observation-result/"]
          ] ;
          rr:predicateObjectMap [
                rr:predicate grel:p_array_a ;
                rr:objectMap
                        [rml:reference "Ostreopsisovatacellgfw"]

          ];
          rr:predicateObjectMap [
                rr:predicate grel:p_array_a ;
                rr:objectMap
                        [rr:constant "cell-g-fw"]

          ];
          rr:predicateObjectMap [
            rr:predicate grel:p_string_sep ;
            rr:objectMap [ rr:constant "-" ]
          ]
        ];
              rr:class w-mon:ObservationValue
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
               rr:template "Observation value {Ostreopsisovatacellgfw}" ; rr:language "en" ] #agg datatype property
          ];

          rr:predicateObjectMap [
            rr:predicate core:hasUnitOfMeasure;
            rr:objectMap [rr:template "http://w3id.org/whow/data/um/cell-g-fw";
            rr:termType rr:IRI;]

            ].


        ### observable property Mapping
        <#ObservablePropertyMapping> a rr:TriplesMap;
        rml:logicalSource <#LogicalSourceOstreopsis>;
        rr:subjectMap [
        rr:template "http://w3id.org/whow/data/observable-property/concentrazione-di-ostreopsis-ovata";
        rr:class w-mon:WaterObservableProperty
                    ];
         rr:predicateObjectMap [
            rr:predicate rdfs:label ;
            rr:objectMap [
               rr:constant "Concentrazione di ostreopsis ovata." ; rr:language "it"]
          ];
         rr:predicateObjectMap [
            rr:predicate w-mon:hasBiologicalAgent ;
            rr:objectMap [rr:template "http://w3id.org/whow/data/biological-agents/biological-agent/ostreopsis-ovata"; rr:termType rr:IRI]
            ].
#water feature (sea) mapping
            <#WaterFeatureBasinMapping> a rr:TriplesMap;
            rml:logicalSource <#LogicalSourceOstreopsis>;
            rr:subjectMap [
            rr:template "http://w3id.org/whow/data/water-feature/{Codice Sito}";
            rr:class hydro:MarineWaterBody
                        ];
             rr:predicateObjectMap [
                rr:predicate rdfs:label ;
                rr:objectMap [
                   rr:template "Marine water feature {Codice Sito}, {Nome Sito}." ; rr:language "en"]
              ];
              rr:predicateObjectMap [
                 rr:predicate core:hasUniqueIdentifier ;
                 rr:objectMap [rr:template "http://w3id.org/whow/data/identifier/{Codice Sito}"; rr:termType rr:IRI]
               ].

              <#UnitOfMeasureMapping> a rr:TriplesMap;
              rml:logicalSource <#LogicalSourceOstreopsis>;
              rr:subjectMap [
              rr:template "http://w3id.org/whow/data/um/cell-l";
              rr:class core:UnitOfMeasure
                          ];
               rr:predicateObjectMap [
                  rr:predicate rdfs:label ;
                  rr:objectMap [
                     rr:template "Unit of measure cell/l." ; rr:language "en"]
                ].

#bbiological agents mappingoutput
<#BiologicalAgentMapping> a rr:TriplesMap;
rml:logicalSource <#LogicalSourceOstreopsis>;
rr:subjectMap [
rr:template "http://w3id.org/whow/data/biological-agents/biological-agent/ostreopsis-ovata";
rr:class w-mon:BiologicalAgent
          ];
rr:predicateObjectMap [
  rr:predicate rdfs:label ;
  rr:objectMap [
     rr:template "Ostreopsis ovata." ; rr:language "it"] #controllare voc contr
];
rr:predicateObjectMap [
   rr:predicate skos:altLabel ;
   rr:objectMap [
      rr:template "Ostreopsis ovata."; rr:language "it"]
 ].

 #ProvincesMapping
 <#ProvincesMapping> a rr:TriplesMap;
 rml:logicalSource <#LogicalSourceOstreopsis>;
 rr:subjectMap [
 rr:template "http://w3id.org/whow/data/provinces/{Provincia}";
 rr:class places:Province
             ];
  rr:predicateObjectMap [
     rr:predicate rdfs:label ;
     rr:objectMap [
        rr:template "Province of {Provincia}" ; rr:language "en"] #controllare voc contr
   ];
   rr:predicateObjectMap [
      rr:predicate rdfs:label ;
      rr:objectMap [
         rr:template "Provincia di {Provincia}" ; rr:language "it"] #controllare voc contr
    ];
   .
   #municipalitymapping
   <#MunicipalityMapping> a rr:TriplesMap;
   rml:logicalSource <#LogicalSourceOstreopsis>;
   rr:subjectMap [
   fnml:functionValue [
    rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:array_join ]
   ] ;
   rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  [ rr:constant "http://w3id.org/whow/data/municipality"]
   ];

   rr:predicateObjectMap [
    rr:predicate grel:p_array_a ;
    rr:objectMap  <#ReplaceWhitespacesWithDashMunicipality>
   ];
   rr:predicateObjectMap [
    rr:predicate grel:p_string_sep ;
    rr:objectMap [ rr:constant "/" ]
   ];
   rr:termtype rr:IRI
   ]
   ];
   rr:predicateObjectMap [
      rr:predicate rdfs:label ;
      rr:objectMap [
         rr:template "Municipality {Comune}" ; rr:language "en"]
    ].

    #Regionmapping
    <#RegionMapping> a rr:TriplesMap;
    rml:logicalSource <#LogicalSourceOstreopsis>;
    rr:subjectMap [
    rr:template "https://w3id.org/whow/data/region/{Regione}";
    rr:termType rr:IRI
    ];
    rr:predicateObjectMap [
       rr:predicate rdfs:label ;
       rr:objectMap [
          rr:template "Region {Regione}" ; rr:language "en"]
     ].

     #Regionmapping
     <#ProvinceMapping> a rr:TriplesMap;
     rml:logicalSource <#LogicalSourceOstreopsis>;
     rr:subjectMap [
     rr:template "https://w3id.org/whow/data/region/{Provincia}";
     rr:termType rr:IRI
     ];
     rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [
           rr:template "Province {Provincia}" ; rr:language "en"]
      ].

#MD5Execution
<#MD5Execution>
fnml:functionValue [
    rml:logicalSource <#LogicalSourceOstreopsis> ;
rr:predicateObjectMap [
       rr:predicate fno:executes ;
       rr:objectMap [ rr:constant grel:string_md5 ]
     ];
     rr:predicateObjectMap [
     rr:predicate grel:valueParameter ;
     rr:objectMap <#ArrayJoinInteraRiga>
       ];
    ].


### Array join intera riga

<#ArrayJoinInteraRiga>
fnml:functionValue [
    rml:logicalSource <#LogicalSourceOstreopsis> ;
rr:predicateObjectMap [
  rr:predicate fno:executes ;
  rr:objectMap [ rr:constant grel:array_join ]
] ;
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Regione}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Provincia}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Comune}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Codice Sito}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Nome Sito}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{LONG }"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{LAT }"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Data}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_array_a ;
  rr:objectMap  [ rr:template "{Ostreopsisovatacelll}"]
];
rr:predicateObjectMap [
  rr:predicate grel:p_string_sep ;
  rr:objectMap [ rr:constant "-" ]
];
].

<#MunicipalityFunction>
fnml:functionValue [
 rr:predicateObjectMap [
 rr:predicate fno:executes ;
 rr:objectMap [ rr:constant grel:array_join ]
] ;
rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
 rr:objectMap  [ rr:constant "http://w3id.org/whow/data/municipality"]
];

rr:predicateObjectMap [
 rr:predicate grel:p_array_a ;
 rr:objectMap  <#ReplaceWhitespacesWithDashMunicipality>
];
rr:predicateObjectMap [
 rr:predicate grel:p_string_sep ;
 rr:objectMap [ rr:constant "/" ]
];
rr:termtype rr:IRI
].

<#ReplaceWhitespacesWithDashMunicipality>
fnml:functionValue [
  rml:logicalSource <#LogicalSourceLaghi>;
  rr:predicateObjectMap [
    rr:predicate fno:executes ;
    rr:objectMap [ rr:constant grel:string_replaceChars ]
 ];

 rr:predicateObjectMap [
     rr:predicate grel:valueParameter ;
     rr:objectMap [ rml:reference "Comune"]
     ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_find ;
    rr:objectMap [ rr:constant " " ]
  ];
  rr:predicateObjectMap [
    rr:predicate grel:p_string_replace ;
    rr:objectMap [ rr:constant "-" ]
];
 ].
